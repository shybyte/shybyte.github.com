jq=jQuery;function log(a){console&&console.log(a)};function getCSSRule(a,d){a=a.toLowerCase();if(document.styleSheets)for(var b=0;b<document.styleSheets.length;b++){var c=document.styleSheets[b],e=0,f=!1;do{if((f=c.cssRules?c.cssRules[e]:c.rules[e])&&f.selectorText.toLowerCase()==a)return"delete"==d?(c.cssRules?c.deleteRule(e):c.removeRule(e),!0):f;e++}while(f)}return!1}function isCanvasSupported(){elem=document.createElement("canvas");return!(!elem.getContext||!elem.getContext("2d"))};(function(){var a=Array.prototype.slice;window.Filters={getCanvas:function(a,b){var c;c=document.createElement("canvas");c.width=a;c.height=b;return c},getPixels:function(a){var b,c;b=this.getCanvas(a.width,a.height);c=b.getContext("2d");c.drawImage(a,0,0);return c.getImageData(0,0,b.width,b.height)},filterImage:function(){var d,b,c;d=arguments[0];b=arguments[1];c=3<=arguments.length?a.call(arguments,2):[];return d.apply(null,[this.getPixels(b)].concat(c))},filterImageData:function(){var d,b,c;d=
arguments[0];b=arguments[1];c=3<=arguments.length?a.call(arguments,2):[];return d.apply(null,[b].concat(c))},filterCanvas:function(){var d,b,c;b=arguments[0];d=arguments[1];c=3<=arguments.length?a.call(arguments,2):[];d=d.getContext("2d").getImageData(0,0,d.width,d.height);return b.apply(null,[d].concat(c))}}}).call(this);Filters.grayscale=function(a){for(var d=a.data,b=0;b<d.length;b+=4)d[b]=d[b+1]=d[b+2]=0.2126*d[b]+0.7152*d[b+1]+0.0722*d[b+2];return a};Filters.grayscaleRG=function(a){for(var d=a.data,b=0;b<d.length;b+=4)d[b]=d[b+1]=d[b+2]=(d[b]+d[b+1])/2;return a};Filters.thresholdRG=function(a,d){for(var b=a.data,c,e=0;e<b.length;e+=4)c=b[e]+b[e+1]>>1>d.threshold?255:0,b[e]=0,b[e+1]=c,b[e+2]=0,b[e+3]=c;return a};if(isCanvasSupported())Filters.tmpCanvas=document.createElement("canvas"),Filters.tmpCtx=Filters.tmpCanvas.getContext("2d");
Filters.createImageData=function(a,d){return this.tmpCtx.createImageData(a,d)};
Filters.convolute=function(a,d,b){for(var c=Math.round(Math.sqrt(d.length)),e=Math.floor(c/2),f=a.data,g=a.width,a=a.height,i=Filters.createImageData(g,a),h=i.data,b=b?1:0,j=0;j<a;j++)for(var o=0;o<g;o++){for(var l=j,r=o,k=4*(j*g+o),q=0,t=0,w=0,m=0,v=0;v<c;v++)for(var u=0;u<c;u++){var n=l+v-e,s=r+u-e;0<=n&&n<a&&0<=s&&s<g&&(n=4*(n*g+s),s=d[v*c+u],q+=f[n]*s,t+=f[n+1]*s,w+=f[n+2]*s,m+=f[n+3]*s)}h[k]=q;h[k+1]=t;h[k+2]=w;h[k+3]=m+b*(255-m)}return i};
Filters.fastGaussian=function(a){for(var d=[0.06,0.061,0.242,0.383,0.242,0.061,0.06],b=a.data,c=a.width,a=a.height,e=Filters.createImageData(c,a).data,f=e,g=0;g<a;g++)for(var i=0;i<c;i++){for(var h=0,j=0,o=0,l=4*(g*c+i-3),r=0;r<d.length;r++){var k=d[r],h=h+b[l++]*k,j=j+b[l++]*k,o=o+b[l++]*k;l++}l=4*(g*c+i);f[l++]=h;f[l++]=j;f[l++]=o;f[l]=255}b=e;e=Filters.createImageData(c,a);f=e.data;for(g=0;g<a;g++)for(i=0;i<c;i++){o=j=h=0;l=4*((g-3)*c+i);for(r=0;r<d.length;r++)var k=d[r]/1.109,q=l+4*r*c,h=h+b[q++]*
k,j=j+b[q++]*k,o=o+b[q]*k;l=4*(g*c+i);f[l++]=h;f[l++]=j;f[l++]=o;f[l]=255}return e};Filters.compressedGrayScaleFromRed=function(a){for(var d=a.data,b=[],c=a.width*a.height,e=0,f=0;f<c;f++)b[f]=d[e],e+=4;return{data:b,width:a.width,height:a.height}};Filters.imageDataFromCompressedGrayScale=function(a){for(var d=Filters.createImageData(a.width,a.height),b=a.data,a=a.width*a.height,c=d.data,e=0,f=0;f<a;f++)c[e]=c[e+1]=c[e+2]=b[f],c[e+3]=255,e+=4;return d};
Filters.meanCGSRepeated=function(a,d,b){for(var c=0;c<b;c++)a=Filters.meanCGS(a,d);return a};Filters.meanCGS=function(a,d){return Filters.meanCGSHorizontal(Filters.meanCGSVertical(a,d),d)};Filters.meanCGSHorizontal=function(a,d){var b=a.data,c=a.width*a.height,e=[],f=0,g=0;initArray(e,c);for(var i=Math.floor(d/2),h=d;h<c;h++)f=f+b[h]-b[g++],e[h-i+1]=f/d;return{data:e,width:a.width,height:a.height}};
Filters.meanCGSVertical=function(a,d){var b=a.data,c=a.width,e=a.height,f=c*e,g=[];initArray(g,f);for(var i=Math.floor(d/2),h=0;h<c;h++)for(var j=0,o=h-i*c,l=h+(i+1)*c,r=h,k=0;k<e;k++)j=j+(l<f?b[l]:0)-(0<=o?b[o]:0),g[r+c]=j/d,o+=c,l+=c,r+=c;return{data:g,width:a.width,height:a.height}};
Filters.peaksCGSOld=function(a,d){var b=a.data,c=a.width,e=a.height,f=[];initArray(f,c*e);for(var g=0;g<c;g++)for(var i=0;i<e;i++){var h=i*c+g,j=b[h];j>d&&j>=b[h+1]&&j>=b[h-1]&&j>=b[h-c]&&j>=b[h+c]&&(f[h]=255)}return{data:f,width:a.width,height:a.height}};
Filters.peaksCGS=function(a,d,b){var c=a.data,e=a.width,f=a.height,g=[],i=[];initArray(i,e*f);for(var h=0;h<e;h++)for(var j=0;j<f;j++){var o=j*e+h,l=c[o];if(l>=d){i[o]=255;var r=Math.min(h+b,e),k=Math.max(h-b,0);a:for(;k<r;k++)for(var q=Math.min(j+b,f),t=Math.max(j-b,0);t<q;t++)if(l<c[t*e+k]&&(h!=k||j!=t)){i[o]=0;break a}255==i[o]&&g.push({x:h,y:j})}}return{data:i,width:a.width,height:a.height,peaks:g}};
Filters.thresholdCGS=function(a,d){for(var b=a.data,c=a.width,e=a.height,f=[],g=0;g<c;g++)for(var i=0;i<e;i++){var h=i*c+g;f[h]=b[h]>=d?255:0}return{data:f,width:a.width,height:a.height}};function initArray(a,d){for(var b=0;b<d;b++)a[b]=0};(function(){var a,d,b,c,e,f,g,i,h,j=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};i=0;c=null;a=["0","1","2","3","4"];e=["0","1"];h="marking";b=function(){function a(b,d){var e;this.pos=b;this.type=d;e=this;this.id=i++;this.el=jq("<div/>").addClass("marking markingType"+this.type).attr({id:this.id,draggable:!1}).bind("dragend",function(){return log("dragend")}).bind("dragstart",function(){e.el.css("opacity","0.4");c=e;return log("dragstart")});
this.move(b)}a.prototype.move=function(a){return this.pos=a};a.prototype.updateScreenPos=function(a,b,c){return this.el.css({left:(this.pos.x-c.x)/a.width*b.width(),top:(this.pos.y-c.y)/a.height*b.height()})};return a}();f=function(){var a,f,i,k,q,t,w,m,v,u,n,s,L,z,A,B,C,D,M,E,G,H,N,p,I,F,J,x,K,y;q=jq("#threshold");f=jq("#fadeThresholdImage");k=jq("#markingsSize");a=jq("#mainCanvas");m=a.get(0);D=jq("#filteredCanvas").get(0);s=m.getContext("2d");L=D.getContext("2d");n={x:0,y:0};p=[];i=jq("#markings");
z="";K=function(){var a;a={markingsSize:k.val(),threshold:q.val(),fadeThresholdImage:f.val(),enabledMarkingTypes:e};return localStorage.cell_counter_settings=JSON.stringify(a)};u=function(){var a,b,c,d,f;K();a=$("#markingTypeSelectors");c=E();a.empty();for(d=0,f=e.length;d<f;d++)b=e[d],b='<div>\n<input id="markingTypeSelector'+b+'" type="radio" name="markingType" value="'+b+'">\n<label for="markingTypeSelector'+b+'" class="markingLabel'+b+'">Count: <span id="cellCount'+b+'">0</span></label>\n</div>',
a.append(b);a=0<=j.call(e,c)?c:e[0];$("#markingTypeSelector"+a).prop("checked",!0);return y()};N=function(){var a,b,c,d,e;F();b=JSON.parse(localStorage["cell_counter_markings_data_"+z]||"[]");e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(t(a.pos,a.type));return e};x=function(){var a,b,c,d;d=[];for(b=0,c=p.length;b<c;b++)a=p[b],d.push({pos:a.pos,type:a.type});return localStorage["cell_counter_markings_data_"+z]=JSON.stringify(d)};I=function(){var a,b;a=getCSSRule(".marking");b=k.val();a.style.width=
b+"px";a.style.height=b+"px";a.style.marginLeft=-b/2+"px";return a.style.marginTop=-b/2+"px"};A=function(b){var c;c=a.offset();return{x:b.pageX-c.left,y:b.pageY-c.top}};B=function(b){b=A(b);return{x:Math.round(b.x/a.width()*m.width)+n.x,y:Math.round(b.y/a.height()*m.height)+n.y}};v=function(){var a,b;a=f.val();a/=128;1>a?b=1:(b=2-a,a=1);jq("#mainCanvas").css("opacity",b);return jq("#filteredCanvas").css("opacity",a)};w=function(a){t(a,E());return x()};E=function(){return jq("input:radio[name=markingType]:checked").val()};
t=function(c,d){var e;e=new b(c,d);p.push(e);i.append(e.el);e.updateScreenPos(m,a,n);return y()};J=function(a){if(a=M(a.x,a.y))return p=_.without(p,a),a.el.remove(),y(),x()};F=function(){var a,b,c;for(b=0,c=p.length;b<c;b++)a=p[b],a.el.remove();p=[];return y()};y=function(){var a,b,c,d,f,h;b=_.groupBy(p,"type");a=function(a){var c,d;return null!=(c=null!=(d=b[a])?d.length:void 0)?c:0};h=[];for(d=0,f=e.length;d<f;d++)c=e[d],h.push(jq("#cellCount"+c).text(a(c)));return h};M=function(a,b){return _.min(p,
function(c){var d;d=c.pos.x-a;c=c.pos.y-b;return d*d+c*c})};H=function(a){var b;b=new FileReader;b.onload=function(b){G(b.target.result);return z=a.name};return b.readAsDataURL(a)};G=function(a){var b;b=new Image;b.onload=function(){m.width=b.width;m.height=b.height;s.drawImage(b,0,0);N();return C()};return b.src=a};C=function(){var a;D.width=m.width;D.height=m.height;a=Filters.filterCanvas(Filters.thresholdRG,m,{threshold:q.val()});return L.putImageData(a,0,0)};window.FileReader||(alert("No local file reading possible. "+
d),jq("#openFile").replaceWith("No local file reading possible. "+a.html()));(function(){var a;if(a=localStorage.cell_counter_settings)a=JSON.parse(a),e=a.enabledMarkingTypes||["0","1"],q.val(a.threshold),k.val(a.markingsSize),f.val(a.fadeThresholdImage),I(),v();return u()})();g(u);u();(function(){var a;a=jq("#openFile");return a.change(function(){var b;b=a.get(0).files;return H(b[0])})})();(function(){return i.bind("dragover",function(){return!1}).bind("dragleave",function(){m.className="";return!1}).bind("drop",
function(a){m.className="";a.preventDefault();if(0<a.originalEvent.dataTransfer.files.length)return H(a.originalEvent.dataTransfer.files[0]);if(c)return 1})})();(function(){i.click(function(a){var b;if("marking"===h)return b=B(a),a.ctrlKey&&0<p.length?J(b):w(b)});return i.bind("contextmenu",function(a){a.preventDefault();return J(B(a))})})();(function(){return $("#autoCountButton").click(function(){var a,b,c,d,e;F();a=Filters.compressedGrayScaleFromRed(s.getImageData(0,0,m.width,m.height));a=Filters.meanCGSRepeated(a,
4,4);a=Filters.peaksCGS(a,q.val(),3);b=E();e=a.peaks;for(c=0,d=e.length;c<d;c++)a=e[c],t({x:a.x+n.x,y:a.y+n.y},b);return x()})})();(function(){var b,c,d,e,f,k,g;c=$("#helpText");b=$("#cropSelection");f=g=null;$("#cropImageLink").click(function(){g=[];h="crop";c.text("Select the top left point!");return c.show("slow")});i.mousemove(function(a){var c;if("crop"===h&&1===g.length)return c=A(a),a=c.x-f.x,c=c.y-f.y,b.css({width:a+"px",height:c+"px"})});i.click(function(a){var e;if("crop"===h){e=A(a);b.css({top:e.y,
left:e.x,width:"5px",height:"5px"}).show();f=e;g.push(B(a));if(1===g.length)return c.text("Select the bottom right point!");if(1<g.length)return c.hide(),b.hide("slow"),h="marking",k(),d()}});k=function(){var a;if(g[1].x<g[0].x)a=g[0].x,g[0].x=g[1].x,g[1].x=a;if(g[1].y<g[0].y)return a=g[0].y,g[0].y=g[1].y,g[1].y=a};d=function(){var a,b,c;c=g[1].x-g[0].x;b=g[1].y-g[0].y;a=s.getImageData(g[0].x-n.x,g[0].y-n.y,c,b);n={x:g[0].x,y:g[0].y};m.width=c;m.height=b;s.putImageData(a,0,0);C();return e()};return e=
function(){var b,c,d,e,f,g;for(d=0,e=p.length;d<e;d++)b=p[d],c=b.pos,n.x<=(f=c.x)&&f<n.x+m.width&&n.y<=(g=c.y)&&g<n.y+m.height?b.updateScreenPos(m,a,n):(b.el.remove(),b.removed=!0);e=[];for(c=0,d=p.length;c<d;c++)b=p[c],b.removed||e.push(b);p=e;x();return y()}})();(function(){var a,b;a=function(a,b){return a.hide().rangeinput().change(function(){K();return b()})};b=function(b,c){return a(b,c).bind("onSlide",c)};k=b(k,I);q=a(q,C);return f=b(f,v)})();G("images/nora1.jpg");(function(){return jq(window).resize(function(){var b,
c,d,e;e=[];for(c=0,d=p.length;c<d;c++)b=p[c],e.push(b.updateScreenPos(m,a,n));return e})})();$("#removeAllMarkings").click(function(){F();return x()});return $("#filterButton").click(function(){var a;a=Filters.filterCanvas(Filters.fastGaussian,m,[0,-1,0,-1,5,-1,0,-1,0]);return s.putImageData(a,0,0)})};g=function(b){var c;c=$("#enabledMarkingTypesSelector");$("#configureLink").click(function(){var b,d,f,g,h;c.empty();h=[];for(f=0,g=a.length;f<g;f++)d=a[f],b=0<=j.call(e,d)?"checked":"",b='<div>\n<input id="enableMarkingType'+
d+'" type="checkbox" value="'+d+'" '+b+'>\n<label for="enableMarkingType'+d+'" class="markingLabel'+d+'">Cell Type '+d+"</label>\n                             </div>",h.push(c.append(b));return h}).overlay({mask:{color:"#ebecff",loadSpeed:200,opacity:0.98},closeOnClick:!1});return jq("#configureOKButton").click(function(){e=[];$("input:checked",c).each(function(a,b){return e.push($(b).val())});return b()})};d="Your browser is too old. Please use a newer version of firefox, google chrome or opera.";
jq(function(){if(isCanvasSupported())return f();jq("#openFile").hide();return alert(d)})}).call(this);
