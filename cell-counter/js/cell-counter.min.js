jQuery.noConflict();jq=jQuery;function log(d){console.log(d)};function getCSSRule(d,c){d=d.toLowerCase();if(document.styleSheets)for(var a=0;a<document.styleSheets.length;a++){var b=document.styleSheets[a],e=0,g=!1;do{if((g=b.cssRules?b.cssRules[e]:b.rules[e])&&g.selectorText.toLowerCase()==d)return"delete"==c?(b.cssRules?b.deleteRule(e):b.removeRule(e),!0):g;e++}while(g)}return!1};(function(){var d=Array.prototype.slice;window.Filters={getCanvas:function(c,a){var b;b=document.createElement("canvas");b.width=c;b.height=a;return b},getPixels:function(c){var a,b;a=this.getCanvas(c.width,c.height);b=a.getContext("2d");b.drawImage(c,0,0);return b.getImageData(0,0,a.width,a.height)},filterImage:function(){var c,a,b;c=arguments[0];a=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[this.getPixels(a)].concat(b))},filterImageData:function(){var c,a,b;c=
arguments[0];a=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[a].concat(b))},filterCanvas:function(){var c,a,b;a=arguments[0];c=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];c=c.getContext("2d").getImageData(0,0,c.width,c.height);return a.apply(null,[c].concat(b))}}}).call(this);Filters.grayscale=function(d){for(var c=d.data,a=0;a<c.length;a+=4)c[a]=c[a+1]=c[a+2]=0.2126*c[a]+0.7152*c[a+1]+0.0722*c[a+2];return d};Filters.thresholdRG=function(d,c){for(var a=d.data,b,e=0;e<a.length;e+=4)b=a[e]+a[e+1]>>1>c.threshold?255:0,a[e]=0,a[e+1]=b,a[e+2]=0,a[e+3]=b;return d};Filters.tmpCanvas=document.createElement("canvas");Filters.tmpCtx=Filters.tmpCanvas.getContext("2d");Filters.createImageData=function(d,c){return this.tmpCtx.createImageData(d,c)};
Filters.convolute=function(d,c,a){for(var b=Math.round(Math.sqrt(c.length)),e=Math.floor(b/2),g=d.data,i=d.width,d=d.height,p=Filters.createImageData(i,d),q=p.data,a=a?1:0,r=0;r<d;r++)for(var j=0;j<i;j++){for(var k=r,m=j,h=4*(r*i+j),l=0,w=0,x=0,t=0,u=0;u<b;u++)for(var v=0;v<b;v++){var s=k+u-e,o=m+v-e;0<=s&&s<d&&0<=o&&o<i&&(s=4*(s*i+o),o=c[u*b+v],l+=g[s]*o,w+=g[s+1]*o,x+=g[s+2]*o,t+=g[s+3]*o)}q[h]=l;q[h+1]=w;q[h+2]=x;q[h+3]=t+a*(255-t)}return p};
Filters.fastGaussian=function(d){for(var c=[0.06,0.061,0.242,0.383,0.242,0.061,0.06],a=d.data,b=d.width,d=d.height,e=Filters.createImageData(b,d).data,g=e,i=0;i<d;i++)for(var p=0;p<b;p++){for(var q=0,r=0,j=0,k=4*(i*b+p-3),m=0;m<c.length;m++)var h=c[m]/1.109,l=k+4*m,q=q+a[l++]*h,r=r+a[l++]*h,j=j+a[l]*h;k=4*(i*b+p);g[k++]=q;g[k++]=r;g[k++]=j;g[k]=255}a=e;e=Filters.createImageData(b,d);g=e.data;for(i=0;i<d;i++)for(p=0;p<b;p++){j=r=q=0;k=4*((i-3)*b+p);for(m=0;m<c.length;m++)h=c[m]/1.109,l=k+4*m*b,q+=
a[l++]*h,r+=a[l++]*h,j+=a[l]*h;k=4*(i*b+p);g[k++]=q;g[k++]=r;g[k++]=j;g[k]=255}return e};(function(){var d,c,a,b,e,g;e=0;c=null;d=function(){function a(b,d){var i;this.pos=b;this.type=d;i=this;this.id=e++;this.el=jq("<div/>").addClass("marking markingType"+this.type).attr({id:this.id,draggable:!1}).bind("dragend",function(){return log("dragend")}).bind("dragstart",function(){i.el.css("opacity","0.4");c=i;return log("dragstart")});this.move(b)}a.prototype.move=function(a){return this.pos=a};a.prototype.updateScreenPos=function(a,b){return this.el.css({left:this.pos.x/a.width*b.width(),
top:this.pos.y/a.height*b.height()})};return a}();a=function(){var a,b,e,g,j,k,m,h,l,w,x,t,u,v,s,o,F,z,A,G,n,B,C,D,E,H,y;j=jq("#threshold");b=jq("#fadeThresholdImage");g=jq("#markingsSize");u=null;a=jq("#mainCanvas");h=a.get(0);o=jq("#filteredCanvas").get(0);w=h.getContext("2d");x=o.getContext("2d");n=[];e=jq("#markings");t="";H=function(){var f;f={markingsSize:g.val(),threshold:j.val(),fadeThresholdImage:b.val()};return localStorage.cell_counter_settings=JSON.stringify(f)};G=function(){var f,a,b,
c,d;C();a=JSON.parse(localStorage["cell_counter_markings_data_"+t]||"[]");d=[];for(b=0,c=a.length;b<c;b++)f=a[b],d.push(k(f.pos,f.type));return d};E=function(){var f,a,b,c;c=[];for(a=0,b=n.length;a<b;a++)f=n[a],c.push({pos:f.pos,type:f.type});return localStorage["cell_counter_markings_data_"+t]=JSON.stringify(c)};B=function(){var f,a;f=getCSSRule(".marking");a=g.val();f.style.width=a+"px";f.style.height=a+"px";f.style.marginLeft=-a/2+"px";return f.style.marginTop=-a/2+"px"};v=function(f){var b,c;
c=a.offset();b=f.pageX-c.left;f=f.pageY-c.top;return{x:Math.round(b/a.width()*h.width),y:Math.round(f/a.height()*h.height)}};l=function(){var f,a;f=b.val();f/=128;1>f?a=1:(a=2-f,f=1);jq("#mainCanvas").css("opacity",a);return jq("#filteredCanvas").css("opacity",f)};m=function(a){k(a,jq("input:radio[name=markingColor]:checked").val());return E()};k=function(f,b){var c;c=new d(f,b);n.push(c);e.append(c.el);c.updateScreenPos(h,a);return y()};D=function(a){if(a=F(a.x,a.y))return n=_.without(n,a),a.el.remove(),
y(),E()};C=function(){var a,b,c;for(b=0,c=n.length;b<c;b++)a=n[b],a.el.remove();n=[];return y()};y=function(){var a,b;b=_.groupBy(n,"type");a=function(a){var f,c;return null!=(f=null!=(c=b[a])?c.length:void 0)?f:0};jq("#cellCount0").text(a(0));return jq("#cellCount1").text(a(1))};F=function(a,b){return _.min(n,function(c){var d;d=c.pos.x-a;c=c.pos.y-b;return d*d+c*c})};A=function(a){var b;b=new FileReader;b.onload=function(b){z(b.target.result);return t=a.name};return b.readAsDataURL(a)};z=function(a){var b;
b=new Image;b.onload=function(){u=b;h.width=b.width;h.height=b.height;w.drawImage(b,0,0);G();return s()};return b.src=a};s=function(){var a;o.width=u.width;o.height=u.height;a=Filters.filterCanvas(Filters.thresholdRG,h,{threshold:j.val()});return x.putImageData(a,0,0)};(function(){var a;if(a=localStorage.cell_counter_settings)return a=JSON.parse(a),log(a),j.val(a.threshold),g.val(a.markingsSize),b.val(a.fadeThresholdImage),B(),l()})();(function(){var a;a=jq("#openFile");return a.change(function(){var b;
b=a.get(0).files;return A(b[0])})})();(function(){return e.bind("dragover",function(){return!1}).bind("dragleave",function(){h.className="";return!1}).bind("drop",function(a){h.className="";a.preventDefault();if(0<a.originalEvent.dataTransfer.files.length)return A(a.originalEvent.dataTransfer.files[0]);if(c)return 1})})();(function(){e.click(function(a){var b;b=v(a);return a.ctrlKey&&0<n.length?D(b):m(b)});return e.bind("contextmenu",function(a){a.preventDefault();return D(v(a))})})();(function(){var a,
c;a=function(a,b){return a.hide().rangeinput().change(function(){H();return b()})};c=function(b,c){return a(b,c).bind("onSlide",c)};g=c(g,B);j=a(j,s);return b=c(b,l)})();z("images/nora1.jpg");(function(){return jq(window).resize(function(){var b,c,d,e;e=[];for(c=0,d=n.length;c<d;c++)b=n[c],e.push(b.updateScreenPos(h,a));return e})})();jq("#removeAllMarkings").click(C);return jq("#filterButton").click(function(){var a;a=Filters.filterCanvas(Filters.fastGaussian,h,[0,-1,0,-1,5,-1,0,-1,0]);return w.putImageData(a,
0,0)})};b=function(){var a;a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))};g=function(){if(!window.FileReader)return alert("No local file reading possible. Please use a newer version of firefox,google chrome or safari")};jq(function(){return b()?(g(),a()):alert("Please use a newer browser.")})}).call(this);
