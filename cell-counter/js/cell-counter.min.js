jQuery.noConflict();jq=jQuery;function log(d){console.log(d)};function getCSSRule(d,c){d=d.toLowerCase();if(document.styleSheets)for(var b=0;b<document.styleSheets.length;b++){var a=document.styleSheets[b],e=0,h=!1;do{if((h=a.cssRules?a.cssRules[e]:a.rules[e])&&h.selectorText.toLowerCase()==d)return"delete"==c?(a.cssRules?a.deleteRule(e):a.removeRule(e),!0):h;e++}while(h)}return!1};(function(){var d=Array.prototype.slice;window.Filters={getCanvas:function(c,b){var a;a=document.createElement("canvas");a.width=c;a.height=b;return a},getPixels:function(c){var b,a;b=this.getCanvas(c.width,c.height);a=b.getContext("2d");a.drawImage(c,0,0);return a.getImageData(0,0,b.width,b.height)},filterImage:function(){var c,b,a;c=arguments[0];b=arguments[1];a=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[this.getPixels(b)].concat(a))},filterImageData:function(){var c,b,a;c=
arguments[0];b=arguments[1];a=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[b].concat(a))},filterCanvas:function(){var c,b,a;b=arguments[0];c=arguments[1];a=3<=arguments.length?d.call(arguments,2):[];c=c.getContext("2d").getImageData(0,0,c.width,c.height);return b.apply(null,[c].concat(a))}}}).call(this);Filters.grayscale=function(d){for(var c=d.data,b=0;b<c.length;b+=4)c[b]=c[b+1]=c[b+2]=0.2126*c[b]+0.7152*c[b+1]+0.0722*c[b+2];return d};Filters.thresholdRG=function(d,c){for(var b=d.data,a,e=0;e<b.length;e+=4)a=b[e]+b[e+1]>>1>c.threshold?255:0,b[e]=0,b[e+1]=a,b[e+2]=0,b[e+3]=a;return d};Filters.tmpCanvas=document.createElement("canvas");Filters.tmpCtx=Filters.tmpCanvas.getContext("2d");Filters.createImageData=function(d,c){return this.tmpCtx.createImageData(d,c)};
Filters.convolute=function(d,c,b){for(var a=Math.round(Math.sqrt(c.length)),e=Math.floor(a/2),h=d.data,m=d.width,d=d.height,r=Filters.createImageData(m,d),j=r.data,b=b?1:0,k=0;k<d;k++)for(var l=0;l<m;l++){for(var i=k,g=l,n=4*(k*m+l),o=0,x=0,u=0,t=0,v=0;v<a;v++)for(var w=0;w<a;w++){var q=i+v-e,s=g+w-e;0<=q&&q<d&&0<=s&&s<m&&(q=4*(q*m+s),s=c[v*a+w],o+=h[q]*s,x+=h[q+1]*s,u+=h[q+2]*s,t+=h[q+3]*s)}j[n]=o;j[n+1]=x;j[n+2]=u;j[n+3]=t+b*(255-t)}return r};
Filters.fastGaussian=function(d){for(var c=[0.06,0.061,0.242,0.383,0.242,0.061,0.06],b=d.data,a=d.width,d=d.height,e=Filters.createImageData(a,d).data,h=e,m=0;m<d;m++)for(var r=0;r<a;r++){for(var j=0,k=0,l=0,i=4*(m*a+r-3),g=0;g<c.length;g++)var n=c[g]/1.109,o=i+4*g,j=j+b[o++]*n,k=k+b[o++]*n,l=l+b[o]*n;i=4*(m*a+r);h[i++]=j;h[i++]=k;h[i++]=l;h[i]=255}b=e;e=Filters.createImageData(a,d);h=e.data;for(m=0;m<d;m++)for(r=0;r<a;r++){l=k=j=0;i=4*((m-3)*a+r);for(g=0;g<c.length;g++)n=c[g]/1.109,o=i+4*g*a,j+=
b[o++]*n,k+=b[o++]*n,l+=b[o]*n;i=4*(m*a+r);h[i++]=j;h[i++]=k;h[i++]=l;h[i]=255}return e};(function(){var d,c,b,a,e;e=0;b=null;d=function(){function a(c,d){var h;this.pos=c;this.type=d;h=this;this.id=e++;this.el=jq("<div/>").addClass("marking markingType"+this.type).attr({id:this.id,draggable:!1}).bind("dragend",function(){return log("dragend")}).bind("dragstart",function(){h.el.css("opacity","0.4");b=h;return log("dragstart")});this.move(c)}a.prototype.move=function(b){return this.pos=b};a.prototype.updateScreenPos=function(b,a){return this.el.css({left:this.pos.x/b.width*a.width(),top:this.pos.y/
b.height*a.height()})};return a}();a=function(){var a,c,e,j,k,l,i,g,n,o,x,u,t,v,w,q,s,z,A,E,p,F,B,C,D,y;k=jq("#threshold");c=jq("#fadeThresholdImage");j=jq("#markingsSize");t=null;a=jq("#mainCanvas");g=a.get(0);q=jq("#filteredCanvas").get(0);o=g.getContext("2d");x=q.getContext("2d");p=[];e=jq("#markings");u="";E=function(){var f,a,b,c,d;B();a=JSON.parse(localStorage["cell_counter_markings_data_"+u]||"[]");d=[];for(b=0,c=a.length;b<c;b++)f=a[b],d.push(l(f.pos,f.type));return d};D=function(){var f,
a,b,c;c=[];for(a=0,b=p.length;a<b;a++)f=p[a],c.push({pos:f.pos,type:f.type});return localStorage["cell_counter_markings_data_"+u]=JSON.stringify(c)};F=function(){var f,a;f=getCSSRule(".marking");a=j.val();f.style.width=a+"px";f.style.height=a+"px";f.style.marginLeft=-a/2+"px";return f.style.marginTop=-a/2+"px"};v=function(f){var b,c;c=a.offset();b=f.pageX-c.left;f=f.pageY-c.top;return{x:Math.round(b/a.width()*g.width),y:Math.round(f/a.height()*g.height)}};n=function(){var f,a;f=c.val();f/=128;1>f?
a=1:(a=2-f,f=1);jq("#mainCanvas").css("opacity",a);return jq("#filteredCanvas").css("opacity",f)};i=function(a){l(a,jq("input:radio[name=markingColor]:checked").val());return D()};l=function(f,b){var c;c=new d(f,b);p.push(c);e.append(c.el);c.updateScreenPos(g,a);return y()};C=function(a){if(a=s(a.x,a.y))return p=_.without(p,a),a.el.remove(),y(),D()};B=function(){var a,b,c;for(b=0,c=p.length;b<c;b++)a=p[b],a.el.remove();p=[];return y()};y=function(){var a,b;b=_.groupBy(p,"type");a=function(a){var c,
f;return null!=(c=null!=(f=b[a])?f.length:void 0)?c:0};jq("#cellCount0").text(a(0));return jq("#cellCount1").text(a(1))};s=function(a,b){return _.min(p,function(c){var d;d=c.pos.x-a;c=c.pos.y-b;return d*d+c*c})};A=function(a){var b;b=new FileReader;b.onload=function(b){z(b.target.result);return u=a.name};return b.readAsDataURL(a)};z=function(a){var b;b=new Image;b.onload=function(){t=b;g.width=b.width;g.height=b.height;o.drawImage(b,0,0);E();return w()};return b.src=a};w=function(){var a;q.width=
t.width;q.height=t.height;a=Filters.filterCanvas(Filters.thresholdRG,g,{threshold:k.val()});return x.putImageData(a,0,0)};(function(){var a;a=jq("#openFile");return a.change(function(){var b;b=a.get(0).files;return A(b[0])})})();(function(){return e.bind("dragover",function(){return!1}).bind("dragleave",function(){g.className="";return!1}).bind("drop",function(a){g.className="";a.preventDefault();if(0<a.originalEvent.dataTransfer.files.length)return A(a.originalEvent.dataTransfer.files[0]);if(b)return 1})})();
(function(){e.click(function(a){var b;b=v(a);return a.ctrlKey&&0<p.length?C(b):i(b)});return e.bind("contextmenu",function(a){a.preventDefault();return C(v(a))})})();(function(){var a,b;a=function(a,b){return a.hide().rangeinput().change(b)};b=function(b,c){return a(b,c).bind("onSlide",c)};j=b(j,F);k=a(k,w);return c=b(c,n)})();z("images/nora1.jpg");(function(){return jq(window).resize(function(){var b,c,d,e;e=[];for(c=0,d=p.length;c<d;c++)b=p[c],e.push(b.updateScreenPos(g,a));return e})})();jq("#removeAllMarkings").click(B);
return jq("#filterButton").click(function(){var a;a=Filters.filterCanvas(Filters.fastGaussian,g,[0,-1,0,-1,5,-1,0,-1,0]);return o.putImageData(a,0,0)})};c=function(){if("undefined"===typeof window.FileReader)return alert("No local file reading possible. Please use a newer version of firefox or google chrome")};jq(function(){c();return a()})}).call(this);
