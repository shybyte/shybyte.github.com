jQuery.noConflict();jq=jQuery;function log(d){console.log(d)};function getCSSRule(d,c){d=d.toLowerCase();if(document.styleSheets)for(var b=0;b<document.styleSheets.length;b++){var a=document.styleSheets[b],e=0,g=!1;do{if((g=a.cssRules?a.cssRules[e]:a.rules[e])&&g.selectorText.toLowerCase()==d)return"delete"==c?(a.cssRules?a.deleteRule(e):a.removeRule(e),!0):g;e++}while(g)}return!1};(function(){var d=Array.prototype.slice;window.Filters={getCanvas:function(c,b){var a;a=document.createElement("canvas");a.width=c;a.height=b;return a},getPixels:function(c){var b,a;b=this.getCanvas(c.width,c.height);a=b.getContext("2d");a.drawImage(c,0,0);return a.getImageData(0,0,b.width,b.height)},filterImage:function(){var c,b,a;c=arguments[0];b=arguments[1];a=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[this.getPixels(b)].concat(a))},filterImageData:function(){var c,b,a;c=
arguments[0];b=arguments[1];a=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[b].concat(a))},filterCanvas:function(){var c,b,a;b=arguments[0];c=arguments[1];a=3<=arguments.length?d.call(arguments,2):[];c=c.getContext("2d").getImageData(0,0,c.width,c.height);return b.apply(null,[c].concat(a))}}}).call(this);Filters.grayscale=function(d){for(var c=d.data,b=0;b<c.length;b+=4)c[b]=c[b+1]=c[b+2]=0.2126*c[b]+0.7152*c[b+1]+0.0722*c[b+2];return d};Filters.thresholdRG=function(d,c){for(var b=d.data,a,e=0;e<b.length;e+=4)a=b[e]+b[e+1]>>1>c.threshold?255:0,b[e]=0,b[e+1]=a,b[e+2]=0,b[e+3]=a;return d};Filters.tmpCanvas=document.createElement("canvas");Filters.tmpCtx=Filters.tmpCanvas.getContext("2d");Filters.createImageData=function(d,c){return this.tmpCtx.createImageData(d,c)};
Filters.convolute=function(d,c,b){for(var a=Math.round(Math.sqrt(c.length)),e=Math.floor(a/2),g=d.data,m=d.width,d=d.height,r=Filters.createImageData(m,d),j=r.data,b=b?1:0,k=0;k<d;k++)for(var l=0;l<m;l++){for(var i=k,f=l,n=4*(k*m+l),o=0,x=0,u=0,t=0,v=0;v<a;v++)for(var w=0;w<a;w++){var q=i+v-e,s=f+w-e;0<=q&&q<d&&0<=s&&s<m&&(q=4*(q*m+s),s=c[v*a+w],o+=g[q]*s,x+=g[q+1]*s,u+=g[q+2]*s,t+=g[q+3]*s)}j[n]=o;j[n+1]=x;j[n+2]=u;j[n+3]=t+b*(255-t)}return r};
Filters.fastGaussian=function(d){for(var c=[0.06,0.061,0.242,0.383,0.242,0.061,0.06],b=d.data,a=d.width,d=d.height,e=Filters.createImageData(a,d).data,g=e,m=0;m<d;m++)for(var r=0;r<a;r++){for(var j=0,k=0,l=0,i=4*(m*a+r-3),f=0;f<c.length;f++)var n=c[f]/1.109,o=i+4*f,j=j+b[o++]*n,k=k+b[o++]*n,l=l+b[o]*n;i=4*(m*a+r);g[i++]=j;g[i++]=k;g[i++]=l;g[i]=255}b=e;e=Filters.createImageData(a,d);g=e.data;for(m=0;m<d;m++)for(r=0;r<a;r++){l=k=j=0;i=4*((m-3)*a+r);for(f=0;f<c.length;f++)n=c[f]/1.109,o=i+4*f*a,j+=
b[o++]*n,k+=b[o++]*n,l+=b[o]*n;i=4*(m*a+r);g[i++]=j;g[i++]=k;g[i++]=l;g[i]=255}return e};(function(){var d,c,b,a,e;e=0;b=null;d=function(){function a(c,d){var g;this.pos=c;this.type=d;g=this;this.id=e++;this.el=jq("<div/>").addClass("marking markingType"+this.type).attr({id:this.id,draggable:!1}).bind("dragend",function(){return log("dragend")}).bind("dragstart",function(){g.el.css("opacity","0.4");b=g;return log("dragstart")});this.move(c)}a.prototype.move=function(b){return this.pos=b};a.prototype.updateScreenPos=function(b,a){return this.el.css({left:this.pos.x/b.width*a.width(),top:this.pos.y/
b.height*a.height()})};return a}();a=function(){var a,c,e,j,k,l,i,f,n,o,x,u,t,v,w,q,s,A,B,G,p,H,C,D,E,y;k=jq("#threshold");c=jq("#fadeThresholdImage");j=jq("#markingsSize");t=null;a=jq("#mainCanvas");f=a.get(0);q=jq("#filteredCanvas").get(0);o=f.getContext("2d");x=q.getContext("2d");p=[];e=jq("#markings");u="";G=function(){var h,F,a,b,c;C();F=JSON.parse(localStorage["markings_data_"+u]||"[]");c=[];for(a=0,b=F.length;a<b;a++)h=F[a],c.push(l(h.pos,h.type));return c};E=function(){var h,a,b,c;c=[];for(a=
0,b=p.length;a<b;a++)h=p[a],c.push({pos:h.pos,type:h.type});return localStorage["markings_data_"+u]=JSON.stringify(c)};H=function(){var h,a;h=getCSSRule(".marking");a=j.val();h.style.width=a+"px";h.style.height=a+"px";h.style.marginLeft=-a/2+"px";return h.style.marginTop=-a/2+"px"};v=function(h){var b,c;c=a.offset();b=h.pageX-c.left;h=h.pageY-c.top;return{x:Math.round(b/a.width()*f.width),y:Math.round(h/a.height()*f.height)}};n=function(){var a,b;a=c.val();a/=128;1>a?b=1:(b=2-a,a=1);jq("#mainCanvas").css("opacity",
b);return jq("#filteredCanvas").css("opacity",a)};i=function(a){l(a,jq("input:radio[name=markingColor]:checked").val());return E()};l=function(b,c){var z;z=new d(b,c);p.push(z);e.append(z.el);z.updateScreenPos(f,a);return y()};D=function(a){if(a=s(a.x,a.y))return p=_.without(p,a),a.el.remove(),y(),E()};C=function(){var a,b,c;for(b=0,c=p.length;b<c;b++)a=p[b],a.el.remove();p=[];return y()};y=function(){var a,b;b=_.groupBy(p,"type");a=function(a){var c,h;return null!=(c=null!=(h=b[a])?h.length:void 0)?
c:0};jq("#cellCount0").text(a(0));return jq("#cellCount1").text(a(1))};s=function(a,b){return _.min(p,function(c){var d;d=c.pos.x-a;c=c.pos.y-b;return d*d+c*c})};B=function(a){var b;b=new FileReader;b.onload=function(b){A(b.target.result);return u=a.name};return b.readAsDataURL(a)};A=function(a){var b;b=new Image;b.onload=function(){t=b;f.width=b.width;f.height=b.height;o.drawImage(b,0,0);G();return w()};return b.src=a};w=function(){var a;q.width=t.width;q.height=t.height;a=Filters.filterCanvas(Filters.thresholdRG,
f,{threshold:k.val()});return x.putImageData(a,0,0)};(function(){var a;a=jq("#openFile");return a.change(function(){var b;b=a.get(0).files;return B(b[0])})})();(function(){return e.bind("dragover",function(){return!1}).bind("dragleave",function(){f.className="";return!1}).bind("drop",function(a){f.className="";a.preventDefault();if(0<a.originalEvent.dataTransfer.files.length)return B(a.originalEvent.dataTransfer.files[0]);if(b)return log("nada")})})();(function(){e.click(function(a){var b;b=v(a);
log(b);return a.ctrlKey&&0<p.length?D(b):i(b)});return e.bind("contextmenu",function(a){a.preventDefault();return D(v(a))})})();(function(){var a,b;a=function(a,b){return a.hide().rangeinput().change(b)};b=function(b,c){return a(b,c).bind("onSlide",c)};j=b(j,H);k=a(k,w);return c=b(c,n)})();A("images/nora1.jpg");(function(){return jq(window).resize(function(){var b,c,d,e;e=[];for(c=0,d=p.length;c<d;c++)b=p[c],e.push(b.updateScreenPos(f,a));return e})})();jq("#removeAllMarkings").click(C);return jq("#filterButton").click(function(){var a;
a=Filters.filterCanvas(Filters.fastGaussian,f,[0,-1,0,-1,5,-1,0,-1,0]);return o.putImageData(a,0,0)})};c=function(){if("undefined"===typeof window.FileReader)return alert("No local file reading possible. Please use a newer version of firefox or google chrome")};jq(function(){c();return a()})}).call(this);
