jq=jQuery;function log(a){console&&console.log(a)};function getCSSRule(a,e){a=a.toLowerCase();if(document.styleSheets)for(var d=0;d<document.styleSheets.length;d++){var c=document.styleSheets[d],b=0,f=!1;do{if((f=c.cssRules?c.cssRules[b]:c.rules[b])&&f.selectorText.toLowerCase()==a)return"delete"==e?(c.cssRules?c.deleteRule(b):c.removeRule(b),!0):f;b++}while(f)}return!1}function isCanvasSupported(){elem=document.createElement("canvas");return!(!elem.getContext||!elem.getContext("2d"))};(function(){var a,e=Array.prototype.slice;a={getCanvas:function(a,c){var b;b=document.createElement("canvas");b.width=a;b.height=c;return b},getPixels:function(a){var c,b;c=this.getCanvas(a.width,a.height);b=c.getContext("2d");b.drawImage(a,0,0);return b.getImageData(0,0,c.width,c.height)},filterImage:function(){var a,c,b;a=arguments[0];c=arguments[1];b=3<=arguments.length?e.call(arguments,2):[];return a.apply(null,[this.getPixels(c)].concat(b))},filterImageData:function(){var a,c,b;a=arguments[0];
c=arguments[1];b=3<=arguments.length?e.call(arguments,2):[];return a.apply(null,[c].concat(b))},filterCanvas:function(){var a,c,b;c=arguments[0];a=arguments[1];b=3<=arguments.length?e.call(arguments,2):[];a=a.getContext("2d").getImageData(0,0,a.width,a.height);return c.apply(null,[a].concat(b))}};if("undefined"!==typeof window)window.Filters=a}).call(this);"undefined"===typeof Filters&&(Filters={});Filters.grayscale=function(a){for(var e=a.data,d=0;d<e.length;d+=4)e[d]=e[d+1]=e[d+2]=0.2126*e[d]+0.7152*e[d+1]+0.0722*e[d+2];return a};Filters.grayscaleRG=function(a){for(var e=a.data,d=0;d<e.length;d+=4)e[d]=e[d+1]=e[d+2]=(e[d]+e[d+1])/2;return a};Filters.thresholdRG=function(a,e){for(var d=a.data,c,b=0;b<d.length;b+=4)c=d[b]+d[b+1]>>1>e.threshold?255:0,d[b]=0,d[b+1]=c,d[b+2]=0,d[b+3]=c;return a};
if("undefined"!==typeof isCanvasSupported&&isCanvasSupported())Filters.tmpCanvas=document.createElement("canvas"),Filters.tmpCtx=Filters.tmpCanvas.getContext("2d");Filters.createImageData=function(a,e){return this.tmpCtx.createImageData(a,e)};
Filters.convolute=function(a,e,d){for(var c=Math.round(Math.sqrt(e.length)),b=Math.floor(c/2),f=a.data,j=a.width,a=a.height,h=Filters.createImageData(j,a),g=h.data,d=d?1:0,k=0;k<a;k++)for(var i=0;i<j;i++){for(var m=k,q=i,n=4*(k*j+i),u=0,r=0,v=0,s=0,w=0;w<c;w++)for(var x=0;x<c;x++){var l=m+w-b,t=q+x-b;0<=l&&l<a&&0<=t&&t<j&&(l=4*(l*j+t),t=e[w*c+x],u+=f[l]*t,r+=f[l+1]*t,v+=f[l+2]*t,s+=f[l+3]*t)}g[n]=u;g[n+1]=r;g[n+2]=v;g[n+3]=s+d*(255-s)}return h};
Filters.fastGaussian=function(a){for(var e=[0.06,0.061,0.242,0.383,0.242,0.061,0.06],d=a.data,c=a.width,a=a.height,b=Filters.createImageData(c,a).data,f=b,j=0;j<a;j++)for(var h=0;h<c;h++){for(var g=0,k=0,i=0,m=4*(j*c+h-3),q=0;q<e.length;q++){var n=e[q],g=g+d[m++]*n,k=k+d[m++]*n,i=i+d[m++]*n;m++}m=4*(j*c+h);f[m++]=g;f[m++]=k;f[m++]=i;f[m]=255}d=b;b=Filters.createImageData(c,a);f=b.data;for(j=0;j<a;j++)for(h=0;h<c;h++){i=k=g=0;m=4*((j-3)*c+h);for(q=0;q<e.length;q++)var n=e[q]/1.109,u=m+4*q*c,g=g+d[u++]*
n,k=k+d[u++]*n,i=i+d[u]*n;m=4*(j*c+h);f[m++]=g;f[m++]=k;f[m++]=i;f[m]=255}return b};Filters.compressedGrayScaleFromRedGreen=function(a){for(var e=a.data,d=[],c=a.width*a.height,b=0,f=0;f<c;f++)d[f]=(e[b]+e[b+1])/2,b+=4;return{data:d,width:a.width,height:a.height}};Filters.compressedGrayScaleFromRedGreenBlue=function(a){for(var e=a.data,d=[],c=a.width*a.height,b=0,f=0;f<c;f++)d[f]=0.2126*e[b]+0.7152*e[b+1]+0.0722*e[b+2],b+=4;return{data:d,width:a.width,height:a.height}};
Filters.compressedGrayScaleFromRed=function(a){for(var e=a.data,d=[],c=a.width*a.height,b=0,f=0;f<c;f++)d[f]=e[b],b+=4;return{data:d,width:a.width,height:a.height}};Filters.imageDataFromCompressedGrayScale=function(a){for(var e=Filters.createImageData(a.width,a.height),d=a.data,a=a.width*a.height,c=e.data,b=0,f=0;f<a;f++)c[b]=c[b+1]=c[b+2]=d[f],c[b+3]=255,b+=4;return e};Filters.meanCGSRepeated=function(a,e,d,c){for(var b=0;b<d;b++)a=Filters.meanCGS(a,e),c&&c(b/d);return a};
Filters.meanCGS=function(a,e){return Filters.meanCGSHorizontal(Filters.meanCGSVertical(a,e),e)};Filters.meanCGSHorizontal=function(a,e){var d=a.data,c=a.width*a.height,b=[],f=0,j=0;initArray(b,c);for(var h=Math.floor(e/2),g=e;g<c;g++)f=f+d[g]-d[j++],b[g-h]=f/e;return{data:b,width:a.width,height:a.height}};
Filters.meanCGSVertical=function(a,e){var d=a.data,c=a.width,b=a.height,f=c*b,j=[];initArray(j,f);for(var h=Math.floor(e/2),g=0;g<c;g++)for(var k=0,i=g-h*c,m=g+(h+1)*c,q=g,n=0;n<b;n++)k=k+(m<f?d[m]:0)-(0<=i?d[i]:0),j[q+c]=k/e,i+=c,m+=c,q+=c;return{data:j,width:a.width,height:a.height}};
Filters.peaksCGSOld=function(a,e){var d=a.data,c=a.width,b=a.height,f=[];initArray(f,c*b);for(var j=0;j<c;j++)for(var h=0;h<b;h++){var g=h*c+j,k=d[g];k>e&&k>=d[g+1]&&k>=d[g-1]&&k>=d[g-c]&&k>=d[g+c]&&(f[g]=255)}return{data:f,width:a.width,height:a.height}};
Filters.peaksCGS=function(a,e,d){var c=a.data,b=a.width,f=a.height,j=[],h=[];initArray(h,b*f);for(var g=0;g<b;g++)for(var k=0;k<f;k++){var i=k*b+g,m=c[i];if(m>=e){h[i]=255;var q=Math.min(g+d,b),n=Math.max(g-d,0);a:for(;n<q;n++)for(var u=Math.min(k+d,f),r=Math.max(k-d,0);r<u;r++)if(m<c[r*b+n]&&(g!=n||k!=r)){h[i]=0;break a}255==h[i]&&j.push({x:g,y:k})}}return{data:h,width:a.width,height:a.height,peaks:j}};
Filters.thresholdCGS=function(a,e){for(var d=a.data,c=a.width,b=a.height,f=[],j=0;j<c;j++)for(var h=0;h<b;h++){var g=h*c+j;f[g]=d[g]>=e?255:0}return{data:f,width:a.width,height:a.height}};function initArray(a,e){for(var d=0;d<e;d++)a[d]=0};(function(){var a,e,d,c,b,f,j,h,g,k,i=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};g=0;c=null;a=["0","1","2","3","4"];b=["0","1"];k="marking";d=function(){function a(b,d){var e;this.pos=b;this.type=d;e=this;this.id=g++;this.el=jq("<div/>").addClass("marking markingType"+this.type).attr({id:this.id,draggable:!1}).bind("dragend",function(){return log("dragend")}).bind("dragstart",function(){e.el.css("opacity","0.4");c=e;return log("dragstart")});
this.move(b)}a.prototype.move=function(a){return this.pos=a};a.prototype.updateScreenPos=function(a,b,c){return this.el.css({left:(this.pos.x-c.x)/a.width*b.width(),top:(this.pos.y-c.y)/a.height*b.height()})};return a}();f=function(){var a,f,g,h,r,v,s,w,x,l,t,B,p,y,U,C,K,D,E,F,G,V,H,L,M,N,W,O,o,I,P,J,Q,R,z,S,T,A;s=jq("#threshold");f=jq("#fadeThresholdImage");h=jq("#markingsSize");r=$("#restoreOriginalImageLink");v=$("#restoreSavedCroppingLink");K=null;a=jq("#mainCanvas");l=a.get(0);G=jq("#filteredCanvas").get(0);
y=l.getContext("2d");U=G.getContext("2d");p={x:0,y:0};T=null;o=[];g=jq("#markings");C="";O=function(){return(T=L("cropWindow",null))?v.show("slow"):v.hide("slow")};S=function(){var a;a={markingsSize:h.val(),threshold:s.val(),fadeThresholdImage:f.val(),enabledMarkingTypes:b};return localStorage.cell_counter_settings=JSON.stringify(a)};B=function(){var a,c,d,e,f;S();a=$("#markingTypeSelectors");d=H();a.empty();for(e=0,f=b.length;e<f;e++)c=b[e],c='<div>\n<input id="markingTypeSelector'+c+'" type="radio" name="markingType" value="'+
c+'">\n<label for="markingTypeSelector'+c+'" class="markingLabel'+c+'">Count: <span id="cellCount'+c+'">0</span></label>\n</div>',a.append(c);a=0<=i.call(b,d)?d:b[0];$("#markingTypeSelector"+a).prop("checked",!0);return A()};W=function(){var a,b,c,d,e;J();b=L("markings_data",[]);e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(w(a.pos,a.type));return e};z=function(){var a,b,c,d;d=[];for(b=0,c=o.length;b<c;b++)a=o[b],d.push({pos:a.pos,type:a.type});return R("markings_data",d)};L=function(a,b){var c,d;
c=localStorage["cell_counter_"+a+"_"+C];return null!=(d=c&&JSON.parse(c))?d:b};R=function(a,b){return localStorage["cell_counter_"+a+"_"+C]=JSON.stringify(b)};I=function(){var a,b;if(a=getCSSRule(".marking"))return b=h.val(),a.style.width=b+"px",a.style.height=b+"px",a.style.marginLeft=-b/2+"px",a.style.marginTop=-b/2+"px";log("Try again to change marking size ...");return setTimeout(I,1E3)};D=function(b){var c;c=a.offset();return{x:b.pageX-c.left,y:b.pageY-c.top}};E=function(b){b=D(b);return{x:Math.round(b.x/
a.width()*l.width)+p.x,y:Math.round(b.y/a.height()*l.height)+p.y}};t=function(){var a,b;a=f.val();a/=128;1>a?b=1:(b=2-a,a=1);jq("#mainCanvas").css("opacity",b);return jq("#filteredCanvas").css("opacity",a)};x=function(a){w(a,H());return z()};H=function(){return jq("input:radio[name=markingType]:checked").val()};w=function(b,c){var e;e=new d(b,c);o.push(e);g.append(e.el);e.updateScreenPos(l,a,p);return A()};Q=function(a){if(a=V(a.x,a.y))return o=_.without(o,a),a.el.remove(),A(),z()};J=function(){var a,
b,c;for(b=0,c=o.length;b<c;b++)a=o[b],a.el.remove();o=[];return A()};A=function(){var a,c,d,e,f,g;c=_.groupBy(o,"type");a=function(a){var b,d;return null!=(b=null!=(d=c[a])?d.length:void 0)?b:0};g=[];for(e=0,f=b.length;e<f;e++)d=b[e],g.push(jq("#cellCount"+d).text(a(d)));return g};V=function(a,b){return _.min(o,function(c){var d;d=c.pos.x-a;c=c.pos.y-b;return d*d+c*c})};N=function(a){var b;b=new FileReader;b.onload=function(b){M(b.target.result);return C=a.name};return b.readAsDataURL(a)};M=function(a){var b;
r.hide("slow");b=new Image;b.onload=function(){return P(b)};return b.src=a};P=function(a){p={x:0,y:0,width:a.width,height:a.height};K=a;l.width=a.width;l.height=a.height;y.drawImage(a,0,0);W();O();return F()};F=function(){var a;G.width=l.width;G.height=l.height;a=Filters.filterCanvas(Filters.thresholdRG,l,{threshold:s.val()});return U.putImageData(a,0,0)};window.FileReader||(alert("No local file reading possible. "+e),jq("#openFile").replaceWith("No local file reading possible. "+a.html()));(function(){var a;
if(a=localStorage.cell_counter_settings)a=JSON.parse(a),b=a.enabledMarkingTypes||["0","1"],s.val(a.threshold),h.val(a.markingsSize),f.val(a.fadeThresholdImage);I();t();return B()})();j(B);$("#helpLink").overlay({mask:{color:"#ebecff",loadSpeed:200,opacity:0.7},closeOnClick:!1});B();(function(){var a;a=jq("#openFile");return a.change(function(){var b;b=a.get(0).files;return N(b[0])})})();(function(){return g.bind("dragover",function(){return!1}).bind("dragleave",function(){l.className="";return!1}).bind("drop",
function(a){l.className="";a.preventDefault();if(0<a.originalEvent.dataTransfer.files.length)return N(a.originalEvent.dataTransfer.files[0]);if(c)return 1})})();(function(){g.click(function(a){var b;if("marking"===k)return b=E(a),a.ctrlKey&&0<o.length?Q(b):x(b)});return g.bind("contextmenu",function(a){a.preventDefault();return Q(E(a))})})();(function(){var a,b,c,d,e;a=$("#autoCountButton");b=$("#countingMessage");c=$("#countingProgress");d=function(a){log(Math.round(100*a).toString());return c.text(Math.round(100*
a).toString())};e=new Worker("js/webworkers.js");e.addEventListener("message",function(c){switch(c.data.cmd){case "autocountProgress":return d(c.data.result);case "autocount":return setTimeout(function(){var d,e,f,g,h;e=H();h=c.data.result;for(f=0,g=h.length;f<g;f++)d=h[f],w({x:d.x+p.x,y:d.y+p.y},e);z();b.hide("slow");return a.attr("disabled",!1)},7)}},!1);e.postMessage({cmd:"start",msg:"bla"});return a.click(function(){var c,f,g;a.attr("disabled",!0);J();d(0);b.show();f=$("#imageTypeSelector").val();
c=y.getImageData(0,0,l.width,l.height);g=s.val();return e.postMessage({cmd:"autocount",imageData:c,threshold:g,imageType:f})})})();(function(){var b,c,d,e,f,h,j,i;b=$("#canvasAndHelpContainer");O();d=$("#helpText");c=$("#cropSelection");h=i=null;$("#cropImageLink").click(function(){i=[];k="crop";d.text("Click the top left point! Press the ESC key to cancel cropping.");d.show("slow");return b.expose({color:"#333",onClose:function(){d.hide();c.hide("slow");return k="marking"}})});g.mousemove(function(a){var b;
if("crop"===k&&1===i.length)return b=D(a),a=b.x-h.x,b=b.y-h.y,c.css({width:a+"px",height:b+"px"})});g.click(function(a){var b;if("crop"===k){b=D(a);c.css({top:b.y,left:b.x,width:"5px",height:"5px"}).show();h=b;i.push(E(a));if(1===i.length)return d.text("Click the bottom right point! Press the ESC key to cancel cropping.");if(1<i.length)return $.mask.close(),j(),e({x:i[0].x,y:i[0].y,width:i[1].x-i[0].x,height:i[1].y-i[0].y})}});j=function(){var a;if(i[1].x<i[0].x)a=i[0].x,i[0].x=i[1].x,i[1].x=a;if(i[1].y<
i[0].y)return a=i[0].y,i[0].y=i[1].y,i[1].y=a};e=function(a){var b;b=y.getImageData(a.x-p.x,a.y-p.y,a.width,a.height);p=a;l.width=a.width;l.height=a.height;y.putImageData(b,0,0);F();f();r.show("slow");return R("cropWindow",p)};f=function(){var b,c,d,e,f,g;for(d=0,e=o.length;d<e;d++)b=o[d],c=b.pos,p.x<=(f=c.x)&&f<p.x+l.width&&p.y<=(g=c.y)&&g<p.y+l.height?b.updateScreenPos(l,a,p):(b.el.remove(),b.removed=!0);e=[];for(c=0,d=o.length;c<d;c++)b=o[c],b.removed||e.push(b);o=e;z();A();return v.hide("slow")};
r.click(function(){r.hide("slow");return P(K)});return v.click(function(){return e(T)})})();(function(){var a,b;a=function(a,b){return a.hide().rangeinput().change(function(){S();return b()})};b=function(b,c){return a(b,c).bind("onSlide",c)};h=b(h,I);s=a(s,F);return f=b(f,t)})();M("images/nora1.jpg");(function(){return jq(window).resize(function(){var b,c,d,e;e=[];for(c=0,d=o.length;c<d;c++)b=o[c],e.push(b.updateScreenPos(l,a,p));return e})})();$("#removeAllMarkings").click(function(){J();return z()});
return $("#filterButton").click(function(){var a;a=Filters.filterCanvas(Filters.fastGaussian,l,[0,-1,0,-1,5,-1,0,-1,0]);return y.putImageData(a,0,0)})};j=function(c){var d;d=$("#enabledMarkingTypesSelector");$("#configureLink").click(function(){var c,e,f,g,h;d.empty();h=[];for(f=0,g=a.length;f<g;f++)e=a[f],c=0<=i.call(b,e)?"checked":"",c='<div>\n<input id="enableMarkingType'+e+'" type="checkbox" value="'+e+'" '+c+'>\n<label for="enableMarkingType'+e+'" class="markingLabel'+e+'">Cell Type '+e+"</label>\n                             </div>",
h.push(d.append(c));return h}).overlay({mask:{color:"#ebecff",loadSpeed:200,opacity:0.7},closeOnClick:!1});return jq("#configureOKButton").click(function(){b=[];$("input:checked",d).each(function(a,c){return b.push($(c).val())});return c()})};e="Your browser is too old. Please use a newer version of firefox, google chrome or opera.";h=function(){return window.applicationCache.addEventListener("updateready",function(){if(window.applicationCache.status===window.applicationCache.UPDATEREADY&&(window.applicationCache.swapCache(),
confirm('A new version of "Marcos Cell Counter" is available. Load it now?')))return window.location.reload()},!1)};jq(function(){if(isCanvasSupported())return h(),f();jq("#openFile").hide();return alert(e)})}).call(this);
