jQuery.noConflict();jq=jQuery;function log(d){console.log(d)};function getCSSRule(d,c){d=d.toLowerCase();if(document.styleSheets)for(var a=0;a<document.styleSheets.length;a++){var b=document.styleSheets[a],e=0,g=!1;do{if((g=b.cssRules?b.cssRules[e]:b.rules[e])&&g.selectorText.toLowerCase()==d)return"delete"==c?(b.cssRules?b.deleteRule(e):b.removeRule(e),!0):g;e++}while(g)}return!1};(function(){var d=Array.prototype.slice;window.Filters={getCanvas:function(c,a){var b;b=document.createElement("canvas");b.width=c;b.height=a;return b},getPixels:function(c){var a,b;a=this.getCanvas(c.width,c.height);b=a.getContext("2d");b.drawImage(c,0,0);return b.getImageData(0,0,a.width,a.height)},filterImage:function(){var c,a,b;c=arguments[0];a=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[this.getPixels(a)].concat(b))},filterImageData:function(){var c,a,b;c=
arguments[0];a=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[a].concat(b))},filterCanvas:function(){var c,a,b;a=arguments[0];c=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];c=c.getContext("2d").getImageData(0,0,c.width,c.height);return a.apply(null,[c].concat(b))}}}).call(this);Filters.grayscale=function(d){for(var c=d.data,a=0;a<c.length;a+=4)c[a]=c[a+1]=c[a+2]=0.2126*c[a]+0.7152*c[a+1]+0.0722*c[a+2];return d};Filters.thresholdRG=function(d,c){for(var a=d.data,b,e=0;e<a.length;e+=4)b=a[e]+a[e+1]>>1>c.threshold?255:0,a[e]=0,a[e+1]=b,a[e+2]=0,a[e+3]=b;return d};Filters.tmpCanvas=document.createElement("canvas");Filters.tmpCtx=Filters.tmpCanvas.getContext("2d");Filters.createImageData=function(d,c){return this.tmpCtx.createImageData(d,c)};
Filters.convolute=function(d,c,a){for(var b=Math.round(Math.sqrt(c.length)),e=Math.floor(b/2),g=d.data,k=d.width,d=d.height,o=Filters.createImageData(k,d),h=o.data,a=a?1:0,i=0;i<d;i++)for(var l=0;l<k;l++){for(var f=i,m=l,j=4*(i*k+l),n=0,t=0,v=0,u=0,s=0;s<b;s++)for(var w=0;w<b;w++){var p=f+s-e,q=m+w-e;0<=p&&p<d&&0<=q&&q<k&&(p=4*(p*k+q),q=c[s*b+w],n+=g[p]*q,t+=g[p+1]*q,v+=g[p+2]*q,u+=g[p+3]*q)}h[j]=n;h[j+1]=t;h[j+2]=v;h[j+3]=u+a*(255-u)}return o};
Filters.fastGaussian=function(d){for(var c=[0.06,0.061,0.242,0.383,0.242,0.061,0.06],a=d.data,b=d.width,d=d.height,e=Filters.createImageData(b,d).data,g=e,k=0;k<d;k++)for(var o=0;o<b;o++){for(var h=0,i=0,l=0,f=4*(k*b+o-3),m=0;m<c.length;m++)var j=c[m]/1.109,n=f+4*m,h=h+a[n++]*j,i=i+a[n++]*j,l=l+a[n]*j;f=4*(k*b+o);g[f++]=h;g[f++]=i;g[f++]=l;g[f]=255}a=e;e=Filters.createImageData(b,d);g=e.data;for(k=0;k<d;k++)for(o=0;o<b;o++){l=i=h=0;f=4*((k-3)*b+o);for(m=0;m<c.length;m++)j=c[m]/1.109,n=f+4*m*b,h+=
a[n++]*j,i+=a[n++]*j,l+=a[n]*j;f=4*(k*b+o);g[f++]=h;g[f++]=i;g[f++]=l;g[f]=255}return e};(function(){var d,c,a,b,e;e=0;a=null;d=function(){function b(c,d){var g;this.pos=c;this.type=d;g=this;this.id=e++;this.el=jq("<div/>").addClass("marking markingType"+this.type).attr({id:this.id,draggable:!1}).bind("dragend",function(){return log("dragend")}).bind("dragstart",function(){g.el.css("opacity","0.4");a=g;return log("dragstart")});this.move(c)}b.prototype.move=function(a){this.pos=a;return this.el.css({left:a.x,top:a.y})};return b}();b=function(){var b,c,e,h,i,l,f,m,j,n,t,v,u,s,w,p,q,r,
A,z,y;i=jq("#threshold");c=jq("#fadeThresholdImage");h=jq("#markingsSize");t=null;b=jq("#mainCanvas");f=b.get(0);s=jq("#filteredCanvas").get(0);j=f.getContext("2d");n=s.getContext("2d");r=[];e=jq("#markings");A=function(){var x,a;x=getCSSRule(".marking");a=h.val();x.style.width=a+"px";x.style.height=a+"px";x.style.marginLeft=-a/2+"px";return x.style.marginTop=-a/2+"px"};v=function(a){var c;c=b.offset();return{x:a.pageX-c.left,y:a.pageY-c.top}};m=function(){var a,b;a=c.val();a/=128;1>a?b=1:(b=2-a,
a=1);jq("#mainCanvas").css("opacity",b);return jq("#filteredCanvas").css("opacity",a)};l=function(a){var b;b=jq("input:radio[name=markingColor]:checked").val();a=new d(a,b);r.push(a);e.append(a.el);return y()};z=function(a){if(a=w(a.x,a.y))return r=_.without(r,a),a.el.remove(),y()};y=function(){var a,b;b=_.groupBy(r,"type");a=function(a){var c,d;return null!=(c=null!=(d=b[a])?d.length:void 0)?c:0};jq("#cellCount0").text(a(0));return jq("#cellCount1").text(a(1))};w=function(a,b){return _.min(r,function(c){var d;
d=c.pos.x-a;c=c.pos.y-b;return d*d+c*c})};p=function(a){var b;b=new Image;b.onload=function(){t=b;f.width=b.width;f.height=b.height;j.drawImage(b,0,0);return u()};return b.src=a};q=function(a){var b;b=new FileReader;b.onload=function(a){return p(a.target.result)};return b.readAsDataURL(a)};u=function(){var a;s.width=t.width;s.height=t.height;a=Filters.filterCanvas(Filters.thresholdRG,f,{threshold:i.val()});return n.putImageData(a,0,0)};(function(){return e.bind("dragover",function(){return!1}).bind("dragleave",
function(){f.className="";return!1}).bind("drop",function(b){f.className="";b.preventDefault();if(0<b.originalEvent.dataTransfer.files.length)return q(b.originalEvent.dataTransfer.files[0]);if(a)return log("nada")})})();(function(){e.click(function(a){var b;b=v(a);return a.ctrlKey&&0<r.length?z(b):l(b)});return e.bind("contextmenu",function(a){a.preventDefault();return z(v(a))})})();(function(){var a,b;a=function(a,b){return a.hide().rangeinput().change(b)};b=function(b,c){return a(b,c).bind("onSlide",
c)};h=b(h,A);i=a(i,u);return c=b(c,m)})();p("images/nora1.jpg");jq("#removeAllMarkings").click(function(){var a,b,c;for(b=0,c=r.length;b<c;b++)a=r[b],a.el.remove();r=[];return y()});return jq("#filterButton").click(function(){var a;a=Filters.filterCanvas(Filters.fastGaussian,f,[0,-1,0,-1,5,-1,0,-1,0]);return j.putImageData(a,0,0)})};c=function(){if("undefined"===typeof window.FileReader)return alert("No local file reading possible. Please use a newer version of firefox or google chrome")};jq(function(){c();
return b()})}).call(this);
