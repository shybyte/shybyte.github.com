jQuery.noConflict();jq=jQuery;function log(d){console&&console.log(d)};function getCSSRule(d,c){d=d.toLowerCase();if(document.styleSheets)for(var a=0;a<document.styleSheets.length;a++){var b=document.styleSheets[a],h=0,j=!1;do{if((j=b.cssRules?b.cssRules[h]:b.rules[h])&&j.selectorText.toLowerCase()==d)return"delete"==c?(b.cssRules?b.deleteRule(h):b.removeRule(h),!0):j;h++}while(j)}return!1}function isCanvasSupported(){elem=document.createElement("canvas");return!(!elem.getContext||!elem.getContext("2d"))};(function(){var d=Array.prototype.slice;window.Filters={getCanvas:function(c,a){var b;b=document.createElement("canvas");b.width=c;b.height=a;return b},getPixels:function(c){var a,b;a=this.getCanvas(c.width,c.height);b=a.getContext("2d");b.drawImage(c,0,0);return b.getImageData(0,0,a.width,a.height)},filterImage:function(){var c,a,b;c=arguments[0];a=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[this.getPixels(a)].concat(b))},filterImageData:function(){var c,a,b;c=
arguments[0];a=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];return c.apply(null,[a].concat(b))},filterCanvas:function(){var c,a,b;a=arguments[0];c=arguments[1];b=3<=arguments.length?d.call(arguments,2):[];c=c.getContext("2d").getImageData(0,0,c.width,c.height);return a.apply(null,[c].concat(b))}}}).call(this);Filters.grayscale=function(d){for(var c=d.data,a=0;a<c.length;a+=4)c[a]=c[a+1]=c[a+2]=0.2126*c[a]+0.7152*c[a+1]+0.0722*c[a+2];return d};Filters.thresholdRG=function(d,c){for(var a=d.data,b,h=0;h<a.length;h+=4)b=a[h]+a[h+1]>>1>c.threshold?255:0,a[h]=0,a[h+1]=b,a[h+2]=0,a[h+3]=b;return d};if(isCanvasSupported())Filters.tmpCanvas=document.createElement("canvas"),Filters.tmpCtx=Filters.tmpCanvas.getContext("2d");Filters.createImageData=function(d,c){return this.tmpCtx.createImageData(d,c)};
Filters.convolute=function(d,c,a){for(var b=Math.round(Math.sqrt(c.length)),h=Math.floor(b/2),j=d.data,i=d.width,d=d.height,g=Filters.createImageData(i,d),k=g.data,a=a?1:0,l=0;l<d;l++)for(var n=0;n<i;n++){for(var f=l,o=n,m=4*(l*i+n),p=0,u=0,v=0,w=0,x=0;x<b;x++)for(var t=0;t<b;t++){var s=f+x-h,r=o+t-h;0<=s&&s<d&&0<=r&&r<i&&(s=4*(s*i+r),r=c[x*b+t],p+=j[s]*r,u+=j[s+1]*r,v+=j[s+2]*r,w+=j[s+3]*r)}k[m]=p;k[m+1]=u;k[m+2]=v;k[m+3]=w+a*(255-w)}return g};
Filters.fastGaussian=function(d){for(var c=[0.06,0.061,0.242,0.383,0.242,0.061,0.06],a=d.data,b=d.width,d=d.height,h=Filters.createImageData(b,d).data,j=h,i=0;i<d;i++)for(var g=0;g<b;g++){for(var k=0,l=0,n=0,f=4*(i*b+g-3),o=0;o<c.length;o++)var m=c[o]/1.109,p=f+4*o,k=k+a[p++]*m,l=l+a[p++]*m,n=n+a[p]*m;f=4*(i*b+g);j[f++]=k;j[f++]=l;j[f++]=n;j[f]=255}a=h;h=Filters.createImageData(b,d);j=h.data;for(i=0;i<d;i++)for(g=0;g<b;g++){n=l=k=0;f=4*((i-3)*b+g);for(o=0;o<c.length;o++)m=c[o]/1.109,p=f+4*o*b,k+=
a[p++]*m,l+=a[p++]*m,n+=a[p]*m;f=4*(i*b+g);j[f++]=k;j[f++]=l;j[f++]=n;j[f]=255}return h};(function(){var d,c,a,b;b=0;c=null;d=function(){function a(d,h){var g;this.pos=d;this.type=h;g=this;this.id=b++;this.el=jq("<div/>").addClass("marking markingType"+this.type).attr({id:this.id,draggable:!1}).bind("dragend",function(){return log("dragend")}).bind("dragstart",function(){g.el.css("opacity","0.4");c=g;return log("dragstart")});this.move(d)}a.prototype.move=function(a){return this.pos=a};a.prototype.updateScreenPos=function(a,b){return this.el.css({left:this.pos.x/a.width*b.width(),top:this.pos.y/
a.height*b.height()})};return a}();a=function(){var a,b,i,g,k,l,n,f,o,m,p,u,v,w,x,t,s,r,z,E,q,A,B,C,D,F,y;k=jq("#threshold");b=jq("#fadeThresholdImage");g=jq("#markingsSize");v=null;a=jq("#mainCanvas");f=a.get(0);t=jq("#filteredCanvas").get(0);m=f.getContext("2d");p=t.getContext("2d");q=[];i=jq("#markings");u="";F=function(){var e;e={markingsSize:g.val(),threshold:k.val(),fadeThresholdImage:b.val()};return localStorage.cell_counter_settings=JSON.stringify(e)};E=function(){var e,a,b,c,d;B();a=JSON.parse(localStorage["cell_counter_markings_data_"+
u]||"[]");d=[];for(b=0,c=a.length;b<c;b++)e=a[b],d.push(l(e.pos,e.type));return d};D=function(){var e,a,b,c;c=[];for(a=0,b=q.length;a<b;a++)e=q[a],c.push({pos:e.pos,type:e.type});return localStorage["cell_counter_markings_data_"+u]=JSON.stringify(c)};A=function(){var e,a;e=getCSSRule(".marking");a=g.val();e.style.width=a+"px";e.style.height=a+"px";e.style.marginLeft=-a/2+"px";return e.style.marginTop=-a/2+"px"};w=function(e){var b,c;c=a.offset();b=e.pageX-c.left;e=e.pageY-c.top;return{x:Math.round(b/
a.width()*f.width),y:Math.round(e/a.height()*f.height)}};o=function(){var e,a;e=b.val();e/=128;1>e?a=1:(a=2-e,e=1);jq("#mainCanvas").css("opacity",a);return jq("#filteredCanvas").css("opacity",e)};n=function(a){l(a,jq("input:radio[name=markingColor]:checked").val());return D()};l=function(e,b){var c;c=new d(e,b);q.push(c);i.append(c.el);c.updateScreenPos(f,a);return y()};C=function(a){if(a=s(a.x,a.y))return q=_.without(q,a),a.el.remove(),y(),D()};B=function(){var a,b,c;for(b=0,c=q.length;b<c;b++)a=
q[b],a.el.remove();q=[];return y()};y=function(){var a,b;b=_.groupBy(q,"type");a=function(a){var e,c;return null!=(e=null!=(c=b[a])?c.length:void 0)?e:0};jq("#cellCount0").text(a(0));return jq("#cellCount1").text(a(1))};s=function(a,b){return _.min(q,function(c){var d;d=c.pos.x-a;c=c.pos.y-b;return d*d+c*c})};z=function(a){var b;b=new FileReader;b.onload=function(b){r(b.target.result);return u=a.name};return b.readAsDataURL(a)};r=function(a){var b;b=new Image;b.onload=function(){v=b;f.width=b.width;
f.height=b.height;m.drawImage(b,0,0);E();return x()};return b.src=a};x=function(){var a;t.width=v.width;t.height=v.height;a=Filters.filterCanvas(Filters.thresholdRG,f,{threshold:k.val()});return p.putImageData(a,0,0)};window.FileReader||(alert("No local file reading possible. Please use a newer version of firefox,google chrome or safari"),jq("#openFile").replaceWith(a.html()));(function(){var a;if(a=localStorage.cell_counter_settings)return a=JSON.parse(a),k.val(a.threshold),g.val(a.markingsSize),
b.val(a.fadeThresholdImage),A(),o()})();(function(){var a;a=jq("#openFile");return a.change(function(){var b;b=a.get(0).files;return z(b[0])})})();(function(){return i.bind("dragover",function(){return!1}).bind("dragleave",function(){f.className="";return!1}).bind("drop",function(a){f.className="";a.preventDefault();if(0<a.originalEvent.dataTransfer.files.length)return z(a.originalEvent.dataTransfer.files[0]);if(c)return 1})})();(function(){i.click(function(a){var b;b=w(a);return a.ctrlKey&&0<q.length?
C(b):n(b)});return i.bind("contextmenu",function(a){a.preventDefault();return C(w(a))})})();(function(){var a,c;a=function(a,b){return a.hide().rangeinput().change(function(){F();return b()})};c=function(b,c){return a(b,c).bind("onSlide",c)};g=c(g,A);k=a(k,x);return b=c(b,o)})();r("images/nora1.jpg");(function(){return jq(window).resize(function(){var b,c,d,g;g=[];for(c=0,d=q.length;c<d;c++)b=q[c],g.push(b.updateScreenPos(f,a));return g})})();jq("#removeAllMarkings").click(B);return jq("#filterButton").click(function(){var a;
a=Filters.filterCanvas(Filters.fastGaussian,f,[0,-1,0,-1,5,-1,0,-1,0]);return m.putImageData(a,0,0)})};jq(function(){if(isCanvasSupported())return a();jq("#openFile").hide();return alert("Please use a newer browser.")})}).call(this);
